<div class="settings-panel-content">
    <div style="margin-top: 20px;">
        <button id="btn-open-nodes-settings" data-i18n="settings.nodesBtn">Entity</button>
    </div>
    <div style="margin-top: 10px;">
        <button id="btn-open-relations-settings" data-i18n="settings.relationsBtn">Relations</button>
    </div>

    <!-- Expansion Settings -->
    <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
        <h4 data-i18n="settings.expansionTitle" style="margin: 0 0 10px 0; color: #555;">Expansion Settings</h4>
        <div class="form-group" style="margin-bottom: 10px;">
            <label for="setting-batch-size" data-i18n="settings.batchSize"
                style="display: block; margin-bottom: 5px;">Batch Size</label>
            <select id="setting-batch-size" style="width: 100%; padding: 5px;">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="500">500</option>
                <option value="1000">1000</option>
                <option value="2000">2000</option>
            </select>
        </div>
        <div class="form-group">
            <label for="setting-max-neighbors" data-i18n="settings.maxNeighbors"
                style="display: block; margin-bottom: 5px;">Max Neighbors</label>
            <select id="setting-max-neighbors" style="width: 100%; padding: 5px;">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="500">500</option>
                <option value="1000">1000</option>
                <option value="2000">2000</option>
                <option value="20000">10000</option>
            </select>
        </div>
        <div class="form-group">
            <label for="setting-max-depth" data-i18n="settings.maxDepth"
                style="display: block; margin-bottom: 5px;">Path Finding Max Depth</label>
            <select id="setting-max-depth" style="width: 100%; padding: 5px;">
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4" selected>4</option>
                <option value="5">5</option>
                <option value="6">6</option>
            </select>
        </div>
    </div>

    <!-- Layout Settings -->
    <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
        <h4 data-i18n="settings.layoutTitle" style="margin: 0 0 10px 0; color: #555;">Layout Settings</h4>
        <div class="form-group">
            <label for="setting-layout" data-i18n="settings.layoutLabel"
                style="display: block; margin-bottom: 5px;">Layout Algorithm</label>
            <select id="setting-layout" style="width: 100%; padding: 5px;">
                <option value="cose" data-i18n="layout.cose" selected>Cose (Physics)</option>
                <option value="grid" data-i18n="layout.grid">Grid</option>
                <option value="circle" data-i18n="layout.circle">Circle</option>
                <option value="concentric" data-i18n="layout.concentric">Concentric</option>
                <option value="breadthfirst" data-i18n="layout.breadthfirst">Breadthfirst (Tree)</option>
            </select>
        </div>
    </div>

    <!-- Graph Actions -->
    <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
        <h4 data-i18n="settings.actionsTitle" style="margin: 0 0 10px 0; color: #555;">Graph Actions</h4>

        <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <label class="switch" style="margin-right: 10px;">
                <input type="checkbox" id="setting-hide-leaves">
                <span class="slider round"></span>
            </label>
            <span data-i18n="settings.hideLeaves">Hide Leaves</span>
        </div>

        <button id="btn-save-image" data-i18n="settings.saveImage"
            style="width: 100%; margin-top: 10px; padding: 8px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Save as Image
        </button>
    </div>

    <!-- Search on Graph -->
    <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
        <h4 data-i18n="settings.searchTitle" style="margin: 0 0 10px 0; color: #555;">Search on Graph</h4>

        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <input type="text" id="search-graph-input" data-i18n-placeholder="settings.searchPlaceholder"
                placeholder="Enter Node ID or Name" style="flex: 1;">
            <button id="btn-search-add" data-i18n="settings.addBtn" style="background-color: #28a745;">Add</button>
        </div>

        <div id="search-list-container"
            style="border: 1px solid #ddd; padding: 5px; height: 100px; overflow-y: auto; margin-bottom: 10px; background: #f9f9f9; border-radius: 4px;">
            <!-- List items will be added here -->
        </div>

        <div style="display: flex; gap: 5px;">
            <button id="btn-search-show" data-i18n="settings.showBtn" style="flex: 1; background-color: #007bff;">Show &
                Blink</button>
            <button id="btn-search-clear" data-i18n="settings.clearBtn"
                style="flex: 1; background-color: #dc3545;">Clear List</button>
        </div>
    </div>

    <div id="node-settings-modal" title="Entity Settings" style="display:none;">
        <!-- Content loaded dynamically -->
    </div>

    <div id="relation-settings-modal" title="Relation Settings" style="display:none;">
        <!-- Content loaded dynamically -->
    </div>

    <script>
        (function () {
            // Initialize Dialogs using Utility
            if (window.AppUtils && window.AppUtils.createModal) {
                window.AppUtils.createModal("#node-settings-modal", { width: 900, height: 'auto' });
                window.AppUtils.createModal("#relation-settings-modal", { width: 1150, height: 'auto' });
            } else {
                console.error("AppUtils.createModal not found");
            }

            function openModal(modalId, url, titleKey, defaultTitle) {
                var $modal = $(modalId);
                var bust = '?t=' + new Date().getTime();

                $.get(url + bust, function (data) {
                    $modal.html(data);

                    if (window.i18n && window.i18n.applyLanguage) {
                        window.i18n.applyLanguage(window.i18n.currentLang);
                    }

                    var title = window.i18n ? window.i18n.get(titleKey) : defaultTitle;
                    if ($modal.hasClass('ui-dialog-content')) {
                        $modal.dialog('option', 'title', title);
                        $modal.dialog('open');

                        // Force center position after a slight delay to allow for rendering
                        setTimeout(function () {
                            $modal.dialog('option', 'position', { my: "center", at: "center", of: window });
                        }, 100);
                    }
                }).fail(function () {
                    console.error("Failed to load " + url);
                    if (window.Graph && window.Graph.showStatus) {
                        window.Graph.showStatus(window.i18n.get('settings.errorLoading'), 'error');
                    }
                });
            }

            $('#btn-open-nodes-settings').on('click', function () {
                openModal('#node-settings-modal', 'partials/nodesettings.html', 'nodesettings.title', 'Entity Settings');
            });

            $('#btn-open-relations-settings').on('click', function () {
                openModal('#relation-settings-modal', 'partials/relationsettings.html', 'relationsettings.title', 'Relation Settings');
            });

            $('#setting-auto-expand').on('change', function () {
                var enabled = $(this).is(':checked');
                if (window.Graph && window.Graph.setAutoExpand) {
                    window.Graph.setAutoExpand(enabled);
                }
            });

            $('#btn-expand-next').on('click', function () {
                if (window.Graph && window.Graph.expandNextBatch) {
                    window.Graph.expandNextBatch();
                } else {
                    console.error("Graph.expandNextBatch not found");
                }
            });
            $('#setting-layout').on('change', function () {
                var layoutName = $(this).val();
                if (window.Graph && window.Graph.changeLayout) {
                    window.Graph.changeLayout(layoutName, true); // Animate on user change
                }
            });

            $('#setting-hide-leaves').on('change', function () {
                var shouldHide = $(this).is(':checked');
                if (window.Graph && window.Graph.toggleLeaves) {
                    window.Graph.toggleLeaves(shouldHide);
                }
            });

            $('#btn-save-image').on('click', function () {
                if (window.Graph && window.Graph.saveAsImage) {
                    window.Graph.saveAsImage();
                }
            });

            // --- Multi-Node Search Logic ---
            var searchList = [];

            function updateSearchListUI() {
                var $container = $('#search-list-container');
                $container.empty();

                if (searchList.length === 0) {
                    $container.append('<div style="color: #999; font-style: italic; text-align: center; padding: 10px;" data-i18n="search.noItems">No items added</div>');
                    if (window.i18n) window.i18n.applyLanguage(window.i18n.currentLang);
                    return;
                }

                searchList.forEach(function (term, index) {
                    var $item = $('<div style="display: flex; justify-content: space-between; align-items: center; padding: 4px; border-bottom: 1px solid #eee; background: #fff;"></div>');
                    $item.append('<span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + term + '</span>');

                    var $removeBtn = $('<span style="cursor: pointer; color: #dc3545; font-weight: bold; padding: 0 5px;">&times;</span>');
                    $removeBtn.on('click', function () {
                        searchList.splice(index, 1);
                        updateSearchListUI();
                        // Re-trigger search to update blinking nodes
                        if (window.Graph && window.Graph.searchNodes) {
                            window.Graph.searchNodes(searchList);
                        }
                    });

                    $item.append($removeBtn);
                    $container.append($item);
                });
            }

            $('#btn-search-add').on('click', function () {
                var val = $('#search-graph-input').val().trim();
                if (val) {
                    searchList.push(val);
                    $('#search-graph-input').val('');
                    updateSearchListUI();
                }
            });

            $('#search-graph-input').on('keypress', function (e) {
                if (e.which === 13) { // Enter key
                    $('#btn-search-add').click();
                }
            });

            $('#btn-search-clear').on('click', function () {
                searchList = [];
                updateSearchListUI();
                // Stop blinking
                if (window.Graph && window.Graph.searchNodes) {
                    window.Graph.searchNodes([]);
                }
            });

            $('#btn-search-show').on('click', function () {
                if (window.Graph && window.Graph.searchNodes) {
                    window.Graph.searchNodes(searchList);
                } else {
                    console.error("Graph.searchNodes not found");
                }
            });

            // Initial render
            updateSearchListUI();

        })();
    </script>
</div>