<div class="filter-panel-content">
    <div class="form-group">
        <select id="view-groups-dropdown" style="width: 100%; padding: 5px;">
            <option value="" data-i18n="datasource.loading">Loading...</option>
        </select>
    </div>
    <div class="form-group" style="margin-top: 10px;">
        <button id="btn-update-viewgroup" data-i18n="datasource.update"
            style="display: none; width: 100%; padding: 6px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Update
        </button>
    </div>
</div>

<script>
    (function () {
        // Access config from parent window
        var config = window.parent.APP_CONFIG;
        if (!config || !config.api || !config.api.viewGroups) {
            console.error("APP_CONFIG or viewGroups API not found");
            $('#view-groups-dropdown').html('<option value="">' + window.i18n.get('datasource.errorConfig') + '</option>');
            return;
        }

        var url = config.api.viewGroups.path;
        var currentLang = window.i18n ? window.i18n.currentLang : 'en-US';

        $.ajax({
            url: url,
            method: config.api.viewGroups.method,
            data: { lang: currentLang },
            success: function (response) {
                var $dropdown = $('#view-groups-dropdown');
                $dropdown.empty();

                // Add default option with data-i18n for dynamic translation
                $dropdown.append('<option value="" data-i18n="datasource.select">' + window.i18n.get('datasource.select') + '</option>');

                if (Array.isArray(response)) {
                    response.forEach(function (item) {
                        // Use specific columns from SP: ViewGroupID, ViewGroupName
                        var value = item.ViewGroupID;
                        var text = item.ViewGroupName;

                        $dropdown.append($('<option>', {
                            value: value,
                            text: text
                        }));
                    });

                    // Auto-select if only one item
                    if (response.length === 1) {
                        var singleValue = response[0].ViewGroupID;
                        $dropdown.val(singleValue).trigger('change');
                    }
                } else {
                    console.error("Expected array response, got:", response);
                    $dropdown.append('<option value="">' + window.i18n.get('datasource.errorData') + '</option>');
                }
            },
            error: function (xhr, status, error) {
                console.error("Error fetching view groups:", error);
                $('#view-groups-dropdown').html('<option value="">' + window.i18n.get('datasource.errorData') + '</option>');
            }
        });

        // Trigger event on change
        $('#view-groups-dropdown').on('change', function () {
            var selectedId = $(this).val();
            var $btnUpdate = $('#btn-update-viewgroup');

            // Show/Hide Update Button
            if (selectedId && parseInt(selectedId) > 0) {
                $btnUpdate.show();
            } else {
                $btnUpdate.hide();
            }

            // Store globally for other components (like Node Settings)
            if (window.parent && window.parent.APP_CONFIG) {
                window.parent.APP_CONFIG.currentViewGroupID = selectedId;
            }

            $(document).trigger('viewGroupChanged', [selectedId]);
        });

        // Update Button Click Handler
        $('#btn-update-viewgroup').on('click', function () {
            var selectedId = $('#view-groups-dropdown').val();
            if (!selectedId || parseInt(selectedId) <= 0) return;

            var $btn = $(this);
            // Use translation for "Updating..."
            $btn.prop('disabled', true).text(window.i18n.get('datasource.updating'));

            var updateUrl = config.api.graphDataGenerate ? config.api.graphDataGenerate.path : null;
            if (!updateUrl) {
                alert("API configuration for 'graphDataGenerate' not found.");
                // Restore button text using translation
                $btn.prop('disabled', false).text(window.i18n.get('datasource.update'));
                return;
            }

            $.ajax({
                url: updateUrl,
                method: 'POST', // Assuming POST as per plan
                contentType: 'application/json',
                data: JSON.stringify({ ViewGroupID: parseInt(selectedId) }),
                success: function (response) {
                    alert("Graph data updated successfully!");
                },
                error: function (xhr, status, error) {
                    console.error("Error updating graph data:", error);
                    alert("Error updating graph data: " + error);
                },
                complete: function () {
                    // Restore button text using translation
                    $btn.prop('disabled', false).text(window.i18n.get('datasource.update'));
                }
            });
        });
    })();
</script>