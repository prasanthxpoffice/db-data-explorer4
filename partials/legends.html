<div id="legends-wrapper">
    <table id="legends-grid"></table>
    <div id="legends-pager"></div>
</div>

<script>
    (function () {
        var config = window.parent.APP_CONFIG;
        var currentViewGroupId = null;

        function initGrid(lang) {
            var $wrapper = $("#legends-wrapper");
            $wrapper.empty();

            // Add Global Date Controls
            var globalControlsHtml = '<div id="global-date-controls" style="padding: 5px; border-bottom: 1px solid #ddd; margin-bottom: 5px;">' +
                '<label>' + window.i18n.get('legends.from') + ': </label>' +
                '<input type="text" id="global-from-date" class="date-input" style="width: 110px; margin-right: 10px;">' +
                '<label>' + window.i18n.get('legends.to') + ': </label>' +
                '<input type="text" id="global-to-date" class="date-input" style="width: 110px; margin-right: 10px;">' +
                '<button id="btn-apply-dates" style="padding: 2px 10px; cursor: pointer;">' + window.i18n.get('filter.apply') + '</button>' +
                '</div>';

            $wrapper.append(globalControlsHtml);
            $wrapper.append('<table id="legends-grid"></table><div id="legends-pager"></div>');

            // Init global datepickers
            $("#global-from-date, #global-to-date").datepicker({
                dateFormat: "dd/mm/yy"
            });

            // Apply Button Handler
            $('#btn-apply-dates').on('click', function () {
                var fromVal = $('#global-from-date').val();
                var toVal = $('#global-to-date').val();

                if (fromVal) {
                    $('#legends-grid .from-date:visible').val(fromVal);
                }
                if (toVal) {
                    $('#legends-grid .to-date:visible').val(toVal);
                }
            });

            var $grid = $("#legends-grid");

            // Helper to check requirement
            function isDateRequired(rowObject) {
                return (rowObject.isDateFilterRequired === true ||
                    rowObject.isDateFilterRequired === "true" ||
                    rowObject.isDateFilterRequired === 1);
            }

            var colModel = [
                { name: 'NodeID', hidden: true, key: true },
                { label: window.i18n.get('legends.nodeName'), name: 'NodeName', width: 120 },
                {
                    label: window.i18n.get('legends.color'),
                    name: 'ColumnColor',
                    width: 40,
                    align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        return '<div style="width: 20px; height: 20px; border-radius: 50%; background-color: ' + cellvalue + '; margin: 0 auto;"></div>';
                    }
                },
                {
                    label: window.i18n.get('legends.date'),
                    name: 'DateFilter',
                    width: 40,
                    align: 'center',
                    sortable: false,
                    formatter: function (cellvalue, options, rowObject) {
                        var id = 'switch_' + options.rowId;
                        var required = isDateRequired(rowObject);
                        var checked = required ? 'checked' : '';
                        return '<label class="switch"><input type="checkbox" id="' + id + '" data-rowid="' + options.rowId + '" ' + checked + '><span class="slider round"></span></label>';
                    }
                },
                {
                    label: window.i18n.get('legends.from'),
                    name: 'FromDate',
                    width: 110,
                    align: 'center',
                    sortable: false,
                    formatter: function (cellvalue, options, rowObject) {
                        var required = isDateRequired(rowObject);
                        var display = required ? '' : 'display: none;';
                        var disabled = required ? '' : 'disabled';
                        // If not required, set default value '01/01/1990'
                        var value = required ? (cellvalue || '') : '01/01/1990';
                        return '<input type="text" class="date-input from-date" data-rowid="' + options.rowId + '" value="' + value + '" ' + disabled + ' style="width: 100%; box-sizing: border-box; ' + display + '">';
                    }
                },
                {
                    label: window.i18n.get('legends.to'),
                    name: 'ToDate',
                    width: 110,
                    align: 'center',
                    sortable: false,
                    formatter: function (cellvalue, options, rowObject) {
                        var required = isDateRequired(rowObject);
                        var display = required ? '' : 'display: none;';
                        var disabled = required ? '' : 'disabled';
                        // If not required, set default value '31/12/2099'
                        var value = required ? (cellvalue || '') : '31/12/2099';
                        return '<input type="text" class="date-input to-date" data-rowid="' + options.rowId + '" value="' + value + '" ' + disabled + ' style="width: 100%; box-sizing: border-box; ' + display + '">';
                    }
                }
            ];

            // Calculate total width
            var totalWidth = colModel.reduce(function (sum, col) { return sum + (col.hidden ? 0 : col.width); }, 0);
            totalWidth += 30; // Add width for multiselect column (approx)

            // Initialize jqGrid with defaults from AppUtils
            var gridOptions = AppUtils.getGridConfig({
                colModel: colModel,
                width: totalWidth,
                multiselect: true,
                pager: "#legends-pager", // Explicitly provided
                caption: window.i18n.get('legends.title'),
                loadComplete: function () {
                    var ids = $grid.jqGrid('getDataIDs');

                    ids.forEach(function (rowId) {
                        var rowData = $grid.jqGrid('getLocalRow', rowId);
                        var isDefault = rowData && (rowData.isDefaultSearch === true || rowData.isDefaultSearch === "true" || rowData.isDefaultSearch === 1);
                        if (isDefault) {
                            $grid.jqGrid('setSelection', rowId, false);
                        }
                    });

                    // Initialize datepicker with a slight delay to ensure DOM is ready
                    setTimeout(function () {
                        $('#legends-grid .date-input').each(function () {
                            if (!$(this).prop('disabled')) {
                                $(this).datepicker({
                                    dateFormat: "dd/mm/yy"
                                });
                            }
                        });
                    }, 100);
                },
                onSelectRow: function () {
                    triggerSelectionChange();
                },
                onSelectAll: function () {
                    triggerSelectionChange();
                },
                beforeSelectRow: function (rowid, e) {
                    var $target = $(e.target);
                    return $target.hasClass('cbox');
                }
            });

            $grid.jqGrid(gridOptions);

            function triggerSelectionChange() {
                var selectedIds = $grid.jqGrid('getGridParam', 'selarrrow');
                if (window.Graph && window.Graph.setVisibleLegendIds) {
                    window.Graph.setVisibleLegendIds(selectedIds);
                }
            }

            // Reload data if a group is selected
            if (currentViewGroupId) {
                loadData(currentViewGroupId, lang);
            }
        }

        function loadData(viewGroupId, lang) {
            var url = config.api.viewGroupNodes.path;
            var $grid = $("#legends-grid");

            $.ajax({
                url: url,
                method: config.api.viewGroupNodes.method,
                data: {
                    viewGroupId: viewGroupId,
                    lang: lang
                },
                success: function (data) {
                    console.log('Legend Data:', data);
                    $grid.jqGrid('clearGridData');
                    $grid.jqGrid('setGridParam', {
                        datatype: 'local',
                        data: data
                    }).trigger("reloadGrid");
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching view group nodes:", error);
                }
            });
        }

        // Initial Load
        initGrid(window.i18n.currentLang);

        // Listen for filter change event
        $(document).on('viewGroupChanged', function (e, viewGroupId) {
            currentViewGroupId = viewGroupId;
            if (!viewGroupId) {
                $("#legends-grid").jqGrid('clearGridData');
                return;
            }
            loadData(viewGroupId, window.i18n.currentLang);
        });

        // Listen for language change event
        $(document).on('languageChanged', function (e, lang) {
            initGrid(lang);
        });

        // Handle Date Switch Toggle
        $(document).on('change', '.switch input', function () {
            var isChecked = $(this).is(':checked');
            var rowId = $(this).data('rowid');
            var $row = $('#' + rowId);
            var $fromInput = $row.find('.from-date');
            var $toInput = $row.find('.to-date');

            if (isChecked) {
                // Enable and clear value for fresh input
                $fromInput.show().prop('disabled', false).val('').datepicker({ dateFormat: "dd/mm/yy" });
                $toInput.show().prop('disabled', false).val('').datepicker({ dateFormat: "dd/mm/yy" });
            } else {
                // Disable, hide, and set default values
                $fromInput.hide().prop('disabled', true).val('01/01/1990').datepicker("destroy");
                $toInput.hide().prop('disabled', true).val('31/12/2099').datepicker("destroy");
            }
        });
    })();
</script>