<div id="legends-wrapper">
    <table id="legends-grid"></table>
    <div id="legends-pager"></div>
</div>

<script>
    (function () {
        var config = window.parent.APP_CONFIG;
        var currentViewGroupId = null;

        function initGrid(lang) {
            var $wrapper = $("#legends-wrapper");
            $wrapper.empty();
            $wrapper.append('<table id="legends-grid"></table><div id="legends-pager"></div>');

            var $grid = $("#legends-grid");

            var colModel = [
                { name: 'NodeID', hidden: true, key: true },
                { label: window.i18n.get('legends.nodeName'), name: 'NodeName', width: 120 },
                {
                    label: window.i18n.get('legends.color'),
                    name: 'ColumnColor',
                    width: 40,
                    align: 'center',
                    formatter: function (cellvalue, options, rowObject) {
                        return '<div style="width: 20px; height: 20px; border-radius: 50%; background-color: ' + cellvalue + '; margin: 0 auto;"></div>';
                    }
                },
                {
                    label: window.i18n.get('legends.date'),
                    name: 'DateFilter',
                    width: 40,
                    align: 'center',
                    sortable: false,
                    formatter: function (cellvalue, options, rowObject) {
                        var id = 'switch_' + options.rowId;
                        // specific logic: if dates are present, check the switch? 
                        // Or maybe isDefaultSearch applies to this? 
                        // User said: "in grid checkbox make checked based on isDefaultSearch"
                        // Usually "grid checkbox" == multiselect. 
                        // Let's assume switch is default off unless we want to persist state (which we don't have yet).
                        // But if FromDate/ToDate are populated from DB, likely we want to show them.
                        // Let's check if either date is present.
                        var hasDate = (rowObject.FromDate || rowObject.ToDate);
                        var checked = hasDate ? 'checked' : '';
                        return '<label class="switch"><input type="checkbox" id="' + id + '" data-rowid="' + options.rowId + '" ' + checked + '><span class="slider round"></span></label>';
                    }
                },
                {
                    label: window.i18n.get('legends.from'),
                    name: 'FromDate',
                    width: 80,
                    align: 'center',
                    sortable: false,
                    formatter: function (cellvalue, options, rowObject) {
                        var hasDate = (rowObject.FromDate || rowObject.ToDate);
                        var display = hasDate ? '' : 'display: none;';
                        var disabled = hasDate ? '' : 'disabled';
                        return '<input type="text" class="date-input from-date" data-rowid="' + options.rowId + '" value="' + (cellvalue || '') + '" ' + disabled + ' style="width: 100%; box-sizing: border-box; ' + display + '">';
                    }
                },
                {
                    label: window.i18n.get('legends.to'),
                    name: 'ToDate',
                    width: 80,
                    align: 'center',
                    sortable: false,
                    formatter: function (cellvalue, options, rowObject) {
                        var hasDate = (rowObject.FromDate || rowObject.ToDate);
                        var display = hasDate ? '' : 'display: none;';
                        var disabled = hasDate ? '' : 'disabled';
                        return '<input type="text" class="date-input to-date" data-rowid="' + options.rowId + '" value="' + (cellvalue || '') + '" ' + disabled + ' style="width: 100%; box-sizing: border-box; ' + display + '">';
                    }
                }
            ];

            // Calculate total width
            var totalWidth = colModel.reduce(function (sum, col) { return sum + (col.hidden ? 0 : col.width); }, 0);
            totalWidth += 30; // Add width for multiselect column (approx)

            // Initialize jqGrid with defaults from AppUtils
            var gridOptions = AppUtils.getGridConfig({
                colModel: colModel,
                width: totalWidth,
                multiselect: true,
                pager: "#legends-pager", // Explicitly provided
                caption: window.i18n.get('legends.title'),
                loadComplete: function () {
                    var ids = $grid.jqGrid('getDataIDs');
                    var data = $grid.jqGrid('getGridParam', 'data');

                    // The 'data' array in local mode matches the source data structure
                    // We need to map IDs to data rows to check isDefaultSearch, 
                    // or iterate ids and getRowData (which might not have hidden/custom fields if not in colModel?)
                    // Safest is to iterate the data array if it's the source.
                    // But getDataIDs returns IDs in order. 

                    // Actually, if datatype is local, 'data' is the array.
                    // Let's try to access the row data by ID.

                    ids.forEach(function (rowId) {
                        var rowData = $grid.jqGrid('getLocalRow', rowId);
                        // isDefaultSearch might be string "true"/"false" or boolean 1/0 or true/false depending on JSON
                        // SP returns bit -> likely boolean true/false or 1/0 in JSON.
                        // Let's match truthy.
                        if (rowData && rowData.isDefaultSearch) {
                            $grid.jqGrid('setSelection', rowId, false); // false = do not trigger onSelectRow? No, false = do not run onSelectRow event? 
                            // Document says: setSelection(rowid, onselect) - onselect is boolean.
                        }
                    });
                },
                onSelectRow: function () {
                    triggerSelectionChange();
                },
                onSelectAll: function () {
                    triggerSelectionChange();
                }
            });

            $grid.jqGrid(gridOptions);

            function triggerSelectionChange() {
                var selectedIds = $grid.jqGrid('getGridParam', 'selarrrow');
                // Trigger global event for Graph to handle
                if (window.Graph && window.Graph.setVisibleLegendIds) {
                    window.Graph.setVisibleLegendIds(selectedIds);
                }
            }

            // Reload data if a group is selected
            if (currentViewGroupId) {
                loadData(currentViewGroupId, lang);
            }
        }

        function loadData(viewGroupId, lang) {
            var url = config.api.viewGroupNodes.path;
            var $grid = $("#legends-grid");

            $.ajax({
                url: url,
                method: config.api.viewGroupNodes.method,
                data: {
                    viewGroupId: viewGroupId,
                    lang: lang
                },
                success: function (data) {
                    $grid.jqGrid('clearGridData');
                    $grid.jqGrid('setGridParam', {
                        datatype: 'local',
                        data: data
                    }).trigger("reloadGrid");
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching view group nodes:", error);
                }
            });
        }

        // Initial Load
        initGrid(window.i18n.currentLang);

        // Listen for filter change event
        $(document).on('viewGroupChanged', function (e, viewGroupId) {
            currentViewGroupId = viewGroupId;
            if (!viewGroupId) {
                $("#legends-grid").jqGrid('clearGridData');
                return;
            }
            loadData(viewGroupId, window.i18n.currentLang);
        });

        // Listen for language change event
        $(document).on('languageChanged', function (e, lang) {
            initGrid(lang);
        });

        // Handle Date Switch Toggle (Delegated to document to handle re-created elements)
        $(document).on('change', '.switch input', function () {
            var isChecked = $(this).is(':checked');
            var rowId = $(this).data('rowid');
            var $row = $('#' + rowId);
            var $inputs = $row.find('.date-input');

            if (isChecked) {
                $inputs.show().prop('disabled', false).datepicker({
                    dateFormat: "dd/mm/yy"
                });
            } else {
                $inputs.hide().prop('disabled', true).val('').datepicker("destroy");
            }
        });
    })();
</script>