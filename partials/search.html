<div class="search-panel-content">
    <div class="form-group">
        <label for="search-nodes-dropdown" data-i18n="search.entity">Entity</label>
        <select id="search-nodes-dropdown" style="width: 100%; padding: 5px;">
            <option value="" data-i18n="search.placeholder">Select a Node...</option>
        </select>
    </div>
    <div class="form-group" style="margin-top: 10px; display: flex; gap: 5px;">
        <input type="text" id="node-search-input" data-i18n-placeholder="search.inputPlaceholder"
            style="width: 100%; padding: 5px; flex-grow: 1;" disabled>
        <button id="add-search-item-btn" data-i18n="search.add" disabled>Add</button>
    </div>

    <div id="search-results" class="search-results-container">
        <div class="no-items" data-i18n="search.noItems" style="color: #888; font-style: italic; font-size: 0.9em;">No
            items added</div>
    </div>

    <div id="find-paths-toggle-container" style="display:none; margin-top: 10px; align-items: center;">
        <label class="switch" style="margin-right: 10px;">
            <input type="checkbox" id="toggle-find-paths">
            <span class="slider round"></span>
        </label>
        <span data-i18n="search.findPaths">Find Paths Between Nodes</span>
    </div>

    <button id="show-graph-btn"
        style="display:none; width: 100%; margin-top: 10px; padding: 8px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;"
        data-i18n="search.show">Show</button>

    <!-- Expansion Controls -->
    <div id="expansion-controls" style="display:none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
            <label class="switch" style="margin-right: 10px;">
                <input type="checkbox" id="setting-auto-expand">
                <span class="slider round"></span>
            </label>
            <span data-i18n="settings.autoExpand">Auto-Expand</span>
        </div>

        <button id="btn-expand-next" data-i18n="settings.expandNext"
            style="width: 100%; padding: 8px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Expand Next Batch
        </button>
    </div>
</div>

<script>
    (function () {
        var config = window.parent.APP_CONFIG;
        if (!config || !config.api || !config.api.viewGroupNodes || !config.api.nodeDataAutoComplete) {
            console.error("APP_CONFIG or APIs not found");
            $('#search-nodes-dropdown').html('<option value="">' + window.i18n.get('datasource.errorConfig') + '</option>');
            return;
        }

        var url = config.api.viewGroupNodes.path;
        var autoCompleteUrl = config.api.nodeDataAutoComplete.path;
        var currentLang = window.i18n ? window.i18n.currentLang : 'en-US';
        var selectedItem = null;

        // Initialize Autocomplete
        $("#node-search-input").autocomplete({
            source: function (request, response) {
                var selectedNodeId = $('#search-nodes-dropdown').val();
                if (!selectedNodeId) return;

                $.ajax({
                    url: autoCompleteUrl,
                    method: config.api.nodeDataAutoComplete.method,
                    data: {
                        NodeID: selectedNodeId,
                        SearchText: request.term,
                        TopCount: 20,
                        Lang: currentLang
                    },
                    success: function (data) {
                        var mappedData = $.map(data, function (item) {
                            return {
                                label: item.NodeValue,
                                value: item.NodeValue,
                                groupNodeId: item.GroupNodeID,
                                nodeValueId: item.NodeValueID
                            };
                        });
                        response(mappedData);
                    },
                    error: function (xhr, status, error) {
                        console.error("Autocomplete error:", error);
                        response([]);
                    }
                });
            },
            minLength: 1,
            select: function (event, ui) {
                selectedItem = ui.item;
                $('#add-search-item-btn').prop('disabled', false);
            }
        });

        // Add Button Logic
        $('#add-search-item-btn').on('click', function () {
            if (selectedItem) {
                var selectedNodeId = parseInt($('#search-nodes-dropdown').val());
                var selectedOption = $('#search-nodes-dropdown option:selected');
                var nodeColor = selectedOption.data('color') || '#4A90E2';

                addSearchCard(selectedItem, selectedNodeId, nodeColor);
                $('#node-search-input').val('');
                selectedItem = null;
                $(this).prop('disabled', true);
            }
        });

        function addSearchCard(item, nodeId, nodeColor) {
            var $container = $('#search-results');
            $container.find('.no-items').hide();

            // Check for duplicates
            var selector = '.search-card[data-group-id="' + item.groupNodeId + '"][data-node-value-id="' + item.nodeValueId + '"]';
            if ($container.find(selector).length > 0) {
                return;
            }

            var cardHtml = `
                <div class="search-card" 
                     data-node-id="${nodeId}"
                     data-group-id="${item.groupNodeId}" 
                     data-node-value-id="${item.nodeValueId}"
                     data-color="${nodeColor}">
                    <span>${item.label}</span>
                    <span class="remove-btn" title="Remove">Ã—</span>
                </div>
            `;
            $container.append(cardHtml);
            updateShowButtonVisibility();
        }

        // Remove Card Logic
        $('#search-results').on('click', '.remove-btn', function () {
            $(this).closest('.search-card').remove();
            if ($('#search-results .search-card').length === 0) {
                $('#search-results .no-items').show();
            }
            updateShowButtonVisibility();
        });

        function updateShowButtonVisibility() {
            var itemCount = $('#search-results .search-card').length;
            $('#show-graph-btn').toggle(itemCount > 0);

            // Show Find Paths toggle only if 2 or more items
            $('#find-paths-toggle-container').toggle(itemCount >= 2);

            // If less than 2 items, uncheck the toggle
            if (itemCount < 2) {
                $('#toggle-find-paths').prop('checked', false);
            }
        }

        // Show Button Logic - Create nodes directly from search list
        $('#show-graph-btn').on('click', function () {
            var searchNodes = [];
            $('#search-results .search-card').each(function () {
                var nodeId = parseInt($(this).data('node-id'));
                var groupId = parseInt($(this).data('group-id'));
                var valueId = $(this).data('node-value-id').toString();
                var color = $(this).data('color');
                var label = $(this).find('span').first().text();

                searchNodes.push({
                    NodeID: nodeId,
                    GroupNodeID: groupId,
                    NodeValueID: valueId,
                    NodeColor: color,
                    NodeValue: label
                });
            });

            if (searchNodes.length === 0) return;

            // Check if Find Paths is enabled
            var findPathsEnabled = $('#toggle-find-paths').is(':checked');

            if (window.Graph && window.Graph.clear) {
                window.Graph.clear();
            }

            if (findPathsEnabled) {
                // Server-Side Path Finding
                if (window.Graph && window.Graph.findPathsServer) {
                    window.Graph.findPathsServer(searchNodes);
                } else {
                    console.error("Graph.findPathsServer not implemented");
                }
            } else {
                // Normal Expansion
                if (window.Graph && window.Graph.createSearchNodes) {
                    window.Graph.createSearchNodes(searchNodes);
                }
                // Show expansion controls only in normal mode
                $('#expansion-controls').show();
            }
        });

        // Auto-Expand Toggle
        $('#setting-auto-expand').on('change', function () {
            var enabled = $(this).is(':checked');
            if (window.Graph && window.Graph.setAutoExpand) {
                window.Graph.setAutoExpand(enabled);
            }
        });

        // Expand Next Batch Button
        $('#btn-expand-next').on('click', function () {
            if (window.Graph && window.Graph.expandNextBatch) {
                var batchSize = parseInt($('#setting-batch-size').val()) || 10;
                window.Graph.expandNextBatch(batchSize);
            }
        });

        // Load nodes dropdown with colors
        function loadSearchNodes(viewGroupId) {
            var $dropdown = $('#search-nodes-dropdown');
            $dropdown.html('<option value="">' + window.i18n.get('search.loading') + '</option>');
            $('#node-search-input').prop('disabled', true).val('');
            $('#add-search-item-btn').prop('disabled', true);

            $.ajax({
                url: url,
                method: config.api.viewGroupNodes.method,
                data: {
                    lang: currentLang,
                    viewGroupId: viewGroupId
                },
                success: function (response) {
                    $dropdown.empty();
                    $dropdown.append('<option value="">' + window.i18n.get('search.placeholder') + '</option>');

                    if (Array.isArray(response)) {
                        response.forEach(function (item) {
                            var value = item.NodeID || item.id;
                            var text = item.NodeName || item.name;
                            var color = item.ColumnColor || '#4A90E2';

                            var option = $('<option>', {
                                value: value,
                                text: text
                            });
                            option.data('color', color);
                            $dropdown.append(option);
                        });
                    }
                },
                error: function (xhr, status, error) {
                    $dropdown.html('<option value="">' + window.i18n.get('search.error') + '</option>');
                }
            });
        }

        $(document).on('viewGroupChanged', function (e, viewGroupId) {
            if (viewGroupId) {
                loadSearchNodes(viewGroupId);
            } else {
                $('#search-nodes-dropdown').empty().append('<option value="">' + window.i18n.get('search.placeholder') + '</option>');
                $('#node-search-input').prop('disabled', true).val('');
                $('#add-search-item-btn').prop('disabled', true);
            }
        });

        $('#search-nodes-dropdown').on('change', function () {
            var val = $(this).val();
            $('#node-search-input').prop('disabled', !val);
            if (!val) {
                $('#node-search-input').val('');
                $('#add-search-item-btn').prop('disabled', true);
            }
        });
    })();
</script>