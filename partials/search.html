<div class="search-panel-content">
    <div class="form-group">
        <label for="search-nodes-dropdown" data-i18n="search.entity">Entity</label>
        <select id="search-nodes-dropdown" style="width: 100%; padding: 5px;">
            <option value="" data-i18n="search.loading">Loading...</option>
        </select>
    </div>
    <div class="form-group" style="margin-top: 10px; display: flex; gap: 5px;">
        <input type="text" id="node-search-input" data-i18n-placeholder="search.inputPlaceholder"
            style="width: 100%; padding: 5px; flex-grow: 1;" disabled>
        <button id="add-search-item-btn" data-i18n="search.add" disabled>Add</button>
    </div>

    <div id="search-results" class="search-results-container">
        <div class="no-items" data-i18n="search.noItems" style="color: #888; font-style: italic; font-size: 0.9em;">No
            items added</div>
    </div>
    <div id="expansion-controls" style="display:none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <div style="display: flex; align-items: center;">
                <label class="switch" style="transform: scale(0.8); margin: 0 5px 0 0;">
                    <input type="checkbox" id="setting-auto-expand">
                    <span class="slider round"></span>
                </label>
                <span data-i18n="settings.autoExpand">Auto-Expand</span>
            </div>
            <div style="flex: 1; display: flex; align-items: center; justify-content: flex-end; gap: 5px;">
                <label for="setting-max-batches" style="font-size: 0.9em; color: #666;"
                    data-i18n="settings.maxBatches">Max Batches:</label>
                <input type="number" id="setting-max-batches" value="10" min="1" max="100"
                    style="width: 50px; padding: 2px;">
            </div>
        </div>
        <button id="btn-expand-next" data-i18n="settings.expandNext"
            style="width: 100%; padding: 8px; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 5px;">
            Expand Next Batch
        </button>
    </div>
    <button id="show-graph-btn"
        style="display:none; width: 100%; margin-top: 10px; padding: 8px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;"
        data-i18n="search.show">Show</button>
</div>

<script>
    (function () {
        // Access config from parent window
        var config = window.parent.APP_CONFIG;
        if (!config || !config.api || !config.api.viewGroupNodes || !config.api.nodeDataAutoComplete) {
            console.error("APP_CONFIG or APIs not found");
            $('#search-nodes-dropdown').html('<option value="">' + window.i18n.get('datasource.errorConfig') + '</option>');
            return;
        }

        var url = config.api.viewGroupNodes.path;
        var autoCompleteUrl = config.api.nodeDataAutoComplete.path;
        var nodesSearchUrl = config.api.nodesSearch.path;
        var currentLang = window.i18n ? window.i18n.currentLang : 'en';
        var selectedItem = null; // Store currently selected autocomplete item

        // Initialize Autocomplete
        $("#node-search-input").autocomplete({
            source: function (request, response) {
                var selectedNodeId = $('#search-nodes-dropdown').val();
                if (!selectedNodeId) return;

                $.ajax({
                    url: autoCompleteUrl,
                    method: config.api.nodeDataAutoComplete.method,
                    data: {
                        NodeID: selectedNodeId,
                        SearchText: request.term,
                        TopCount: 20,
                        Lang: currentLang
                    },
                    success: function (data) {
                        var mappedData = $.map(data, function (item) {
                            return {
                                label: item.NodeValue,
                                value: item.NodeValue,
                                id: item.NodeDataID
                            };
                        });
                        response(mappedData);
                    },
                    error: function (xhr, status, error) {
                        console.error("Autocomplete error:", error);
                        response([]);
                    }
                });
            },
            minLength: 1,
            select: function (event, ui) {
                selectedItem = ui.item;
                $('#add-search-item-btn').prop('disabled', false);
            }
        });

        // Add Button Logic
        $('#add-search-item-btn').on('click', function () {
            if (selectedItem) {
                addSearchCard(selectedItem);
                // Reset input
                $('#node-search-input').val('');
                selectedItem = null;
                $(this).prop('disabled', true);
            }
        });

        function addSearchCard(item) {
            var $container = $('#search-results');
            $container.find('.no-items').hide();

            // Check for duplicates
            if ($container.find('.search-card[data-id="' + item.id + '"]').length > 0) {
                return; // Already added
            }

            var cardHtml = `
                <div class="search-card" data-id="${item.id}">
                    <span>${item.label}</span>
                    <span class="remove-btn" title="Remove">Ã—</span>
                </div>
            `;
            $container.append(cardHtml);
            updateShowButtonVisibility();
        }

        // Remove Card Logic (Delegated)
        $('#search-results').on('click', '.remove-btn', function () {
            $(this).closest('.search-card').remove();
            if ($('#search-results .search-card').length === 0) {
                $('#search-results .no-items').show();
            }
            updateShowButtonVisibility();
        });

        function updateShowButtonVisibility() {
            var hasItems = $('#search-results .search-card').length > 0;
            if (hasItems) {
                $('#show-graph-btn').show();
            } else {
                $('#show-graph-btn').hide();
                $('#expansion-controls').hide(); // Hide if no items to search
            }
        }

        // Auto-Expand Logic
        $('#setting-auto-expand').on('change', function () {
            var enabled = $(this).is(':checked');
            if (enabled) {
                $('#btn-expand-next').hide();
            } else {
                $('#btn-expand-next').show();
            }
            // Update Graph state if it exists
            if (window.Graph && window.Graph.setAutoExpand) {
                window.Graph.setAutoExpand(enabled);
            }
        });

        $('#btn-expand-next').on('click', function () {
            if (window.Graph && window.Graph.expandNextBatch) {
                window.Graph.expandNextBatch();
            }
        });

        // Show Button Logic
        $('#show-graph-btn').on('click', function () {
            var nodeDataIds = [];
            $('#search-results .search-card').each(function () {
                nodeDataIds.push(parseInt($(this).data('id')));
            });

            if (nodeDataIds.length === 0) return;

            // Clear existing graph before showing new results
            if (window.Graph && window.Graph.clear) {
                window.Graph.clear();
            }

            // Hide controls initially when starting new search
            $('#expansion-controls').hide();

            // Check Auto-Expand State
            var autoExpand = $('#setting-auto-expand').is(':checked');
            if (window.Graph && window.Graph.setAutoExpand) {
                window.Graph.autoExpand = autoExpand;
                window.Graph.autoExpandCount = 0;
            }

            $.ajax({
                url: nodesSearchUrl,
                method: config.api.nodesSearch.method,
                contentType: "application/json",
                data: JSON.stringify({
                    nodeDataIds: nodeDataIds,
                    lang: currentLang
                }),
                success: function (response) {
                    if (window.Graph && window.Graph.addNodes) {
                        window.Graph.addNodes(response);

                        // Show expansion controls if we have nodes
                        if (response && response.length > 0) {
                            $('#expansion-controls').show();
                        }

                        // Trigger Auto-Expand if enabled
                        if (autoExpand && window.Graph.expandNextBatch) {
                            setTimeout(function () {
                                window.Graph.expandNextBatch();
                            }, 1000);
                        }
                    } else {
                        console.error("Graph module not found in window");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error searching nodes:", error);
                    alert(window.i18n.get('search.failedLoad'));
                }
            });
        });

        function loadSearchNodes(viewGroupId) {
            var $dropdown = $('#search-nodes-dropdown');
            $dropdown.html('<option value="">' + window.i18n.get('search.loading') + '</option>');
            $('#node-search-input').prop('disabled', true).val('');
            $('#add-search-item-btn').prop('disabled', true);

            $.ajax({
                url: url,
                method: config.api.viewGroupNodes.method,
                data: {
                    lang: currentLang,
                    viewGroupId: viewGroupId
                },
                success: function (response) {
                    $dropdown.empty();
                    $dropdown.append('<option value="">' + window.i18n.get('search.placeholder') + '</option>');

                    if (Array.isArray(response)) {
                        response.forEach(function (item) {
                            var value = item.NodeID || item.id;
                            var text = item.NodeName || item.name;
                            $dropdown.append($('<option>', { value: value, text: text }));
                        });
                    } else {
                        $dropdown.append('<option value="">' + window.i18n.get('search.error') + '</option>');
                    }
                },
                error: function (xhr, status, error) {
                    $dropdown.html('<option value="">' + window.i18n.get('search.error') + '</option>');
                }
            });
        }

        $(document).on('viewGroupChanged', function (e, viewGroupId) {
            if (viewGroupId) {
                loadSearchNodes(viewGroupId);
            } else {
                $('#search-nodes-dropdown').empty().append('<option value="">' + window.i18n.get('search.placeholder') + '</option>');
                $('#node-search-input').prop('disabled', true).val('');
                $('#add-search-item-btn').prop('disabled', true);
            }
        });

        $('#search-nodes-dropdown').on('change', function () {
            var val = $(this).val();
            $('#node-search-input').prop('disabled', !val);
            if (!val) {
                $('#node-search-input').val('');
                $('#add-search-item-btn').prop('disabled', true);
            }
        });
    })();
</script>